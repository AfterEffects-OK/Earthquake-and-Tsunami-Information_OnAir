# 地震・津波情報トラッカーO.A. 仕様書・操作マニュアル
https://aftereffects-ok.github.io/Earthquake-and-Tsunami-Information_OnAir/

## 1. 概要
このアプリケーションは、P2P地震情報APIからリアルタイムに地震・津波情報を取得し、分かりやすく表示するWebアプリケーションです。
デフォルトで**最大震度3以上**の地震情報を一覧で確認できるほか（表示する最低震度は設定変更可能）、**緊急地震速報（予報）**にも対応しています。

また、動画配信のテロップとして利用することを想定した「情報表示バー」機能を搭載しており、OBS等の配信ソフトと簡単に連携できます。

## 2. 主な機能

*   **地震情報の自動取得・更新**: 定期的に最新の地震情報をAPIから取得し、画面に反映します。
*   **地震一覧表示**: 設定された最低震度（デフォルトは震度3）以上の地震を発生時刻の新しい順に一覧表示します。
*   **地震詳細表示**: 選択した地震の震源地、マグニチュード、各地の震度などの詳細情報を表示します。
*   **情報の自動集約**: 震度速報や震源に関する情報など、同じ地震に対して発表される複数の情報を自動的に1つに統合します。後から発表された詳細な情報（観測点データや確定したマグニチュードなど）をマージするため、より正確な情報を確認できます。
*   **緊急地震速報（予報）の表示**: 緊急地震速報（予報）が発表された際に、画面上部に警告バーを表示し、対象地域と予測震度を即座に通知します。
*   **津波情報の詳細表示**: 地震に伴い津波警報・注意報が発表された場合、対象となっている沿岸エリアを詳細パネルや情報表示バーに表示します。
*   **表示モード切替**: 詳細表示パネルの震度別観測地点を「市区町村別」または「観測点別」で切り替えられます。
*   **情報表示バー（テロップ機能）**: 選択した地震の情報（震度、津波情報を含む）を、配信画面に載せることを想定したテロップ形式で表示・再生します。
*   **訓練モード**: 画面上のボタン一つで、津波警報を含む大規模な地震を想定した訓練用のダミーデータに切り替え、表示をテストすることができます。

## 3. 画面構成と操作方法

**【重要】訓練モードについて**

このアプリケーションには訓練モードが搭載されていますが、訓練モードで表示される画面は実際の地震情報とは異なります。配信等で利用する際は、必ず通常モードで使用してください。


画面は大きく分けて「**緊急地震速報バー**（画面上部）」「**地震一覧パネル**（左側）」「**地震詳細パネル**（右側）」「**情報表示バー**（画面下部）」の4つのエリアで構成されています。

### 3.1. 地震一覧パネル（左側）

<img src="地震一覧パネル.png" alt="地震一覧パネル" width="400"/>

| UI要素 | 機能説明 |
| :--- | :--- |
| **訓練モードへボタン** | クリックすると、訓練用のダミーデータ表示に切り替わります。訓練モード中はボタンが「通常モードへ」に変わり、画面上部に警告が表示されます。ループ再生中は無効になります。 |
| **API更新ボタン** | クリックすると、手動で最新の地震情報に更新します。更新中は「取得中...」と表示されます。 |
| **最終取得日時** | 最後にAPIからデータを取得した時刻を表示します。 |
| **地震リスト** | 震度3以上の地震が一覧表示されます。各項目には「震源地」「地震発生日時」「最大震度」「津波情報」が表示されます。 |
| | **操作**: リスト内の項目をクリックすると、右側の「地震詳細パネル」と下部の「情報表示バー」の内容がその地震の情報に更新されます。選択された項目は青くハイライトされます。 |

### 3.2. 地震詳細パネル（右側）

<img src="地震詳細パネル.png" alt="地震詳細パネル" width="600"/>

| UI要素 | 機能説明 |
| :--- | :--- |
| **パネルタイトル** | 通常は「地震詳細」と表示されます。津波警報・注意報が発表されている地震を選択した場合は「地震・津波詳細」に変わります。 |
| **市区町村別 / 観測点別 トグルスイッチ** | 震度別観測地点の表示粒度を切り替えます。<br>・**市区町村別**: 同じ市区町村内の複数の観測点は1つにまとめて表示します。（デフォルト）<br>・**観測点別**: 全ての観測点名を個別に表示します。 |
| **地震情報ヘッダー** | 選択した地震の「震源地」と「最大震度」を表示します。 |
| **放送原稿を作成ボタン** | クリックすると、選択中の地震情報を元に、アナウンス用の読み上げ原稿を生成し、新しいタブで表示します。（詳細は「3.5. 放送原稿ページ」を参照） |
| **サマリー情報** | 「発生日時」「震源の深さ」「マグニチュード」「津波の有無」に関する詳細情報を表示します。<br>・**震源の深さ**: 深さ0kmの場合は「ごく浅い」と表示されます。 |
| **津波詳細情報** | 大津波警報、津波警報、津波注意報が発表されている場合、警報の種別ごとに発表中の沿岸エリアが一覧で表示されます。 |
| **震度別観測地点** | 設定された表示モード（市区町村別/観測点別）に基づき、震度1以上の揺れを観測した地域を震度別に一覧表示します。津波情報がある場合は、その下に区切り線を挟んで表示されます。 |

### 3.3. 情報表示バー（画面下部）

選択した地震の情報を、配信テロップのように1ページずつ表示・再生するための機能です。

<img src="情報表示バー.png" alt="情報表示バー" width="800"/>

#### 操作パネル（左側）

| UI要素 | 機能説明 |
| :--- | :--- |
| **秒数入力欄** | 自動再生時の1ページあたりの表示時間を秒単位で設定します。（デフォルト: 10秒） |
| **ループ回数選択** | 自動再生を何回繰り返すかを選択します。（デフォルト: 3回, `∞`で無限ループ） |
| **◀ / ▶ ボタン** | 情報ページを手動で前後に送ります。自動再生中は無効になります。 |
| **ページ情報** | `現在のページ / 総ページ数` を表示します。自動再生中はループ回数も `L:現在のループ/総ループ` の形式で表示されます。 |
| **再生/停止ボタン** | 情報の自動ページ送りを開始・停止します。 |
| **トランジション選択** | ページ切り替え時のエフェクトを「カット」または「スライド」から選択します。 |
| **リセットボタン** | 情報表示バーの表示を初期状態（非表示）に戻します。自動再生も停止します。 |
| **設定アイコン** 　| クリックすると「設定」モーダルが開きます。 |

#### コンテンツ表示エリア（右側）

| UI要素 | 機能説明 |
| :--- | :--- |
| **情報バッジ** | 現在表示している情報ページの震度階級やカテゴリ（例: `概況`, `大津波警報`, `震度7`）を表示します。 |
| **テキスト表示エリア** | 地震の震源情報、津波の発表状況、警報発表沿岸、震度ごとの観測地点名などを表示します。文字には黒い縁取りが適用されます。 |

#### OBSでの利用方法（推奨）

情報表示バーの右側（コンテンツ表示エリア）は、背景が**透明**になるように設計されています。
これにより、OBS Studioなどの配信ソフトでクロマキー合成を行うことなく、簡単にテロップとして利用できます。

1.  OBSで「ソース」を追加し、「**ウィンドウキャプチャ**」を選択します。
2.  キャプチャするウィンドウとして、このアプリケーションが表示されているブラウザを選択します。（ソースサイズは 1500ｘ900 以上）
3.  ソースのプロパティを開き、「**透過を許可**」のチェックボックスをオンにします。
4.  必要に応じて、`Alt`キーを押しながらソースの境界をドラッグし、コンテンツ表示エリアのみが映るようにクロップ（トリミング）します。
以上の設定で、ゲーム画面やその他の映像の上に、背景なしで地震情報テロップを重ねて表示できます。

### 3.5. 放送原稿ページ

地震詳細パネルの「放送原稿を作成」ボタンから開くことができる、アナウンスでの読み上げに特化したページです。

<img src="放送原稿ページ.png" alt="放送原稿ページ" width="800"/>

| UI要素 | 機能説明 |
| :--- | :--- |
| **白黒反転ボタン** | 画面右上に配置されています。クリックすると、ページの配色（背景と文字色）を白黒反転させることができます。夜間や暗い場所での視認性を向上させます。 |
| **ページのトップへボタン** | 画面を下にスクロールすると右下に表示されます。クリックすると、スムーズにページの最上部へ移動します。 |
| **原稿本文** | 読み上げやすいように、以下の特徴を持っています。<br>・**ふりがな**: 震源地と市区町村名には、ふりがな（ルビ）が自動で振られます。<br>・**読みやすいレイアウト**: 文字は大きく太く表示され、行間や市区町村間のスペースも十分に確保されています。<br>・**重複情報の整理**: 同じ市区町村が複数の震度で観測された場合、最も大きい震度の箇所にのみ表示され、重複が排除されます。<br>・**読み上げ表現の最適化**: マグニチュードなどの情報は、ニュースで読み上げる際のような自然な表現に調整されています。 |

### 3.4. 設定モーダル

<img src="設定モーダル.png" alt="設定モーダル" width="400"/>

| UI要素 | 機能説明 |
| :--- | :--- |
| **再生/停止ショートカット** | 情報表示バーの自動再生を開始/停止するためのキーボードショートカットを設定できます。入力欄を選択し、設定したいキーの組み合わせ（例: `Ctrl + Space`）を押してください。 |
| **地震一覧に表示する最低震度** | 左側の地震一覧パネルに表示する地震の最低震度を設定します。（デフォルト: 震度3以上） |
| **緊急地震速報の通知音** | 緊急地震速報（予報）受信時に通知音を再生するかどうかを設定します。（デフォルト: ON） |
| **情報画面に表示する最低震度** | 情報表示バーで再生される震度情報の最低ラインを設定します。例えば「震度4以上」に設定すると、震度3の地域情報は再生されなくなります。（デフォルト: 震度3以上） |
| **震度ごとの色分け設定** | 各震度階級（震度1〜7）の表示色を個別に設定できます。カラーピッカーで任意の色を選択してください。 |
| **保存ボタン** | 設定した内容をブラウザに保存し、モーダルを閉じます。 |

## 4. 仕様詳細

*   **API**: P2P地震情報 API v2 を使用しています。
    *   取得対象コード:
        *   `551`: 地震情報
        *   `552`: 津波情報
        *   `554`: 緊急地震速報（予報）
        *   `556`: 地震・津波に関するお知らせ
*   **データ更新頻度**:
    *   **自動更新**: 2分ごと。
    *   **手動更新**: 「API更新」ボタン押下時。
*   **リスト表示対象**: APIから取得した直近100件のデータのうち、**最大震度が3以上** (`maxScale >= 30`) の地震。
*   **データ集約ロジック**:
    *   **安定したID生成**: API提供のIDに依存せず、「地震発生時刻」と「震源地名」を組み合わせてハッシュ化することで、常に安定したユニークIDを生成します。
    *   **情報のマージ**: 同じ地震イベント（同じID）に対して複数の情報が取得された場合、より詳細な情報（観測点データを持つ、マグニチュードが確定している等）を優先して1つのデータに統合します。
    *   **観測点データの保持**: APIから取得する情報が古くなると観測点データが省略されることがあるため、観測点データを持つ情報を優先的に保持するようになっています。
*   **情報表示バーのページ分割**:
    *   サマリー情報や観測地点リストがテキスト表示エリアの2行に収まらない場合、自動的に複数のページに分割して表示します。
*   **設定の永続化**:
    *   「ショートカットキー」と「情報画面に表示する最低震度」の設定は、ブラウザのローカルストレージに保存され、次回アクセス時も維持されます。
    *   「緊急地震速報の通知音」および「震度ごとの色分け設定」も同様にローカルストレージに保存されます。
